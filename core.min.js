"use strict";async function fetchGameConfig(){const response=await fetch("game.json");return await response.json()}function Game(config){this.gameConfig=config;this.currentScene=null;this.selectedAnswers=[];this.defaultScaleDuration=this.gameConfig.game.defaultScaleDuration||500;this.quizConfig=null;this.currentQuestionIndex=0;this.questionClicks={};this.isInInterstitial=false;this.lastQuestionCorrect=null;this.explorationConfig=null;this.discoveredTargets=new Set;this.explorationState={isDragging:false,dragOffset:{x:0,y:0},currentPopup:null,progressImageIndex:0};this.dragUpdateListener=null;this.dragEndListener=null;this.touchUpdateListener=null;this.touchEndListener=null;this.init()}Game.prototype.init=function(){document.title=this.gameConfig.game.title;if(this.gameConfig.game.preloadImages){this.preloadAllImages().then(()=>{this.completeInit()})}else{this.completeInit()}};Game.prototype.completeInit=function(){const vh=window.innerHeight*.01;document.documentElement.style.setProperty("--vh",`${vh}px`);this.setupBackground();this.setupScenes();if(window.emit&&this.currentScene){window.emit({scene:this.currentScene,sub_scene:"",action:"scene_load",self:"",value:"",target:""})}if(this.gameConfig.game.containerBackground){this.setupBackground("game-container",this.gameConfig.game.containerBackground)}this.resizeTimeout=null;window.addEventListener("resize",()=>{clearTimeout(this.resizeTimeout);this.resizeTimeout=setTimeout(()=>{this.setupBackground();if(this.gameConfig.game.containerBackground){this.setupBackground("game-container",this.gameConfig.game.containerBackground)}const currentSceneConfig=this.gameConfig.scenes.find(s=>s.name===this.currentScene);if(currentSceneConfig&&currentSceneConfig.pageBackground){this.setupBackground("background",currentSceneConfig.pageBackground)}if(currentSceneConfig&&currentSceneConfig.containerBackground){this.setupBackground("game-container",currentSceneConfig.containerBackground)}},this.gameConfig.game.resizeDebounce)});window.addEventListener("orientationchange",()=>{setTimeout(()=>{this.handleOrientationChange()},100)});document.addEventListener("contextmenu",e=>{e.preventDefault();return false});let lastTouchEnd=0;document.addEventListener("touchend",e=>{const now=Date.now();if(now-lastTouchEnd<=300){e.preventDefault()}lastTouchEnd=now},false);const inputs=document.querySelectorAll("input, textarea, select");inputs.forEach(input=>{input.addEventListener("focus",()=>{input.setAttribute("readonly","readonly");setTimeout(()=>{input.removeAttribute("readonly");input.focus()},100)})});const scenes=document.querySelectorAll(".scene");scenes.forEach(scene=>{scene.style.transition=`opacity ${this.gameConfig.game.fadeDuration}ms ease-in-out`})};Game.prototype.handleOrientationChange=function(){this.setupBackground();if(this.gameConfig.game.containerBackground){this.setupBackground("game-container",this.gameConfig.game.containerBackground)}const currentSceneConfig=this.gameConfig.scenes.find(s=>s.name===this.currentScene);if(currentSceneConfig&&currentSceneConfig.pageBackground){this.setupBackground("background",currentSceneConfig.pageBackground)}if(currentSceneConfig&&currentSceneConfig.containerBackground){this.setupBackground("game-container",currentSceneConfig.containerBackground)}const vh=window.innerHeight*.01;document.documentElement.style.setProperty("--vh",`${vh}px`);document.body.style.display="none";document.body.offsetHeight;document.body.style.display=""};Game.prototype.preloadAllImages=function(){return new Promise(resolve=>{const{urls:urls,backgroundUrls:backgroundUrls}=this.collectImageUrls();const allUrls=[...urls,...backgroundUrls];if(allUrls.length===0){this.hideLoadingOverlay();resolve();return}const preloadContainer=document.createElement("div");preloadContainer.id="preload-container";preloadContainer.style.position="absolute";preloadContainer.style.opacity="0";preloadContainer.style.pointerEvents="none";preloadContainer.style.zIndex="-1";document.body.appendChild(preloadContainer);this.preloadedImages=[];this.showLoadingOverlay();let loadedCount=0;let failedCount=0;const totalImages=allUrls.length;const maxRetries=3;const retryDelay=1e3;const updateProgress=()=>{const progress=(loadedCount+failedCount)/totalImages*100;this.updateLoadingProgress(progress)};const onImageComplete=()=>{loadedCount++;updateProgress();if(loadedCount+failedCount===totalImages){this.hideLoadingOverlay();resolve()}};const attemptLoadImage=(url,attempt=1,isBackground=false)=>{const img=document.createElement("img");preloadContainer.appendChild(img);this.preloadedImages.push(img);if(isBackground){const div=document.createElement("div");div.style.width="100px";div.style.height="100px";div.style.backgroundImage=`url(${url})`;div.style.backgroundSize="cover";preloadContainer.appendChild(div);this.preloadedImages.push(div)}const onSuccess=()=>{onImageComplete()};const onError=()=>{if(attempt<maxRetries){setTimeout(()=>{attemptLoadImage(url,attempt+1,isBackground)},retryDelay*attempt)}else{console.warn(`Failed to load image after ${maxRetries} attempts: ${url}`);failedCount++;updateProgress();if(loadedCount+failedCount===totalImages){this.hideLoadingOverlay();resolve()}}};img.onload=onSuccess;img.onerror=onError;img.src=url};urls.forEach(url=>{attemptLoadImage(url,1,false)});backgroundUrls.forEach(url=>{attemptLoadImage(url,1,true)})})};Game.prototype.showLoadingOverlay=function(){const overlay=document.getElementById("loading-overlay");if(overlay){overlay.classList.remove("hidden")}};Game.prototype.hideLoadingOverlay=function(){const overlay=document.getElementById("loading-overlay");if(overlay){setTimeout(()=>{overlay.classList.add("hidden")},500)}};Game.prototype.updateLoadingProgress=function(percentage){const fill=document.getElementById("loading-fill");const percentageText=document.getElementById("loading-percentage");if(fill){fill.style.width=`${percentage}%`}if(percentageText){percentageText.textContent=`${Math.round(percentage)}%`}};Game.prototype.collectImageUrls=function(){const urls=new Set;const backgroundUrls=new Set;const processBackgrounds=(backgrounds,isBackground=false)=>{if(!backgrounds)return;const bgArr=Array.isArray(backgrounds)?backgrounds:[backgrounds];bgArr.forEach(bg=>{if(bg.type==="image"){if(isBackground){backgroundUrls.add(bg.value)}else{urls.add(bg.value)}}})};processBackgrounds(this.gameConfig.game.pageBackground,true);processBackgrounds(this.gameConfig.game.containerBackground,true);this.gameConfig.scenes.forEach(scene=>{processBackgrounds(scene.background,true);processBackgrounds(scene.pageBackground,true);processBackgrounds(scene.containerBackground,true);const collectFromElements=elements=>{elements.forEach(element=>{if(element.type==="container"&&element.elements){collectFromElements(element.elements)}processBackgrounds(element.background,true);if(element.type==="picture"&&element.url){if(element.location==="local"){urls.add(element.url)}else if(element.location==="external"){urls.add(element.url)}}if(element.type==="exploration"&&element.config){const config=element.config;if(config.magnifier&&config.magnifier.image){urls.add(config.magnifier.image)}if(config.targets){config.targets.forEach(target=>{if(target.image)urls.add(target.image);if(target.discoveredImage)urls.add(target.discoveredImage);if(target.popup&&target.popup.image)urls.add(target.popup.image)})}if(config.progress&&config.progress.images){Object.values(config.progress.images).forEach(image=>{if(image)urls.add(image)})}if(config.completion&&config.completion.continueButton&&config.completion.continueButton.image){urls.add(config.completion.continueButton.image)}}})};if(scene.elements){collectFromElements(scene.elements)}});return{urls:Array.from(urls),backgroundUrls:Array.from(backgroundUrls)}};Game.prototype.setupBackground=function(elementId="background",bgArray=null){if(!bgArray)bgArray=this.gameConfig.game.pageBackground;const background=document.getElementById(elementId);const width=window.innerWidth;let selectedBg=null;let highestPriority=-1;const priorities={all:0,mobile:1,tablet:2,desktop:3};const bgArr=Array.isArray(bgArray)?bgArray:[bgArray];bgArr.forEach(bg=>{if(bg.target==="all"||bg.target==="mobile"&&width<this.gameConfig.game.tabletSize||bg.target==="tablet"&&width>=this.gameConfig.game.tabletSize&&width<this.gameConfig.game.desktopSize||bg.target==="desktop"&&width>=this.gameConfig.game.desktopSize){if(priorities[bg.target]>highestPriority){highestPriority=priorities[bg.target];selectedBg=bg}}});if(selectedBg){if(selectedBg.type==="image"){background.style.backgroundImage="";background.style.backgroundColor=selectedBg.fallback_colour||"";if(selectedBg.value){let url=selectedBg.value;if(selectedBg.variant==="local"){url=selectedBg.value}if(this.gameConfig.game.preloadImages){background.style.backgroundImage=`url(${url})`;background.style.backgroundSize=selectedBg.size||"cover";background.style.backgroundRepeat=selectedBg.repeat||"no-repeat";background.style.backgroundPosition=selectedBg.position||"center center"}else{const testImg=new Image;testImg.onload=()=>{background.style.backgroundImage=`url(${url})`;background.style.backgroundSize=selectedBg.size||"cover";background.style.backgroundRepeat=selectedBg.repeat||"no-repeat";background.style.backgroundPosition=selectedBg.position||"center center"};testImg.onerror=()=>{console.warn(`Failed to load background image: ${url}`);background.style.backgroundImage=""};testImg.src=url}}else{background.style.backgroundImage=""}}else if(selectedBg.type==="colour"){background.style.backgroundImage="";if(selectedBg.variant==="hex"){if(selectedBg.value==="transparent"){background.style.backgroundColor="transparent"}else{background.style.backgroundColor="#"+selectedBg.value}}else if(selectedBg.variant==="literal"){background.style.backgroundColor=selectedBg.value}else if(selectedBg.variant==="rgb"){background.style.backgroundColor=`rgb(${selectedBg.value})`}else if(selectedBg.variant==="rgba"){background.style.backgroundColor=`rgba(${selectedBg.value})`}}}if(elementId==="background"){const container=document.getElementById("game-container");const vh=window.innerHeight;const vw=window.innerWidth;const aspect=this.gameConfig.game.containerAspectRatio;if(vw/vh>aspect){container.style.height="100vh";container.style.width=`${100*aspect}vh`}else{container.style.width="100vw";container.style.height=`${100/aspect}vw`}}};Game.prototype.setupScenes=function(){const gameContainer=document.getElementById("game-container");this.gameConfig.scenes.forEach(sceneConfig=>{const sceneDiv=document.createElement("div");sceneDiv.id=sceneConfig.name+"-scene";sceneDiv.className="scene";sceneDiv.setAttribute("data-scene",sceneConfig.name);if(!sceneConfig.initial){sceneDiv.classList.add("hidden");sceneDiv.style.display="none"}else{this.currentScene=sceneConfig.name}gameContainer.appendChild(sceneDiv);if(sceneConfig.elements){this.createElements(sceneConfig.elements,sceneDiv)}if(sceneConfig.background){this.setupBackground(sceneConfig.name+"-scene",sceneConfig.background)}})};Game.prototype.createElements=function(elements,parentElement){elements.forEach(element=>{this.createElement(element,parentElement)})};Game.prototype.createElement=function(element,parentElement){if(element.type==="container"){const containerDiv=document.createElement("div");containerDiv.id=element.id;containerDiv.className="game-element container";if(element.hidden)containerDiv.classList.add("hidden");containerDiv.style.position="relative";if(element.variant==="vflex"){containerDiv.style.flexDirection="column"}else if(element.variant==="hflex"){containerDiv.style.flexDirection="row"}if(element.width)containerDiv.style.width=element.width;else containerDiv.style.width="100%";if(element.height)containerDiv.style.height=element.height;else containerDiv.style.height="100%";containerDiv.style.alignItems=element.alignItems||"center";if(element.flexGrow!==undefined)containerDiv.style.flexGrow=element.flexGrow;if(element.flexShrink!==undefined)containerDiv.style.flexShrink=element.flexShrink;if(element.flexBasis!==undefined)containerDiv.style.flexBasis=element.flexBasis+"%";parentElement.appendChild(containerDiv);if(element.background){this.setupBackground(element.id,element.background)}if(element.elements){this.createElements(element.elements,containerDiv)}}else if(element.type==="picture"){const picture=document.createElement("picture");picture.id=element.id;picture.className="game-element picture";if(element.clickable)picture.classList.add("clickable");if(element.hidden)picture.classList.add("hidden");picture.style.position="absolute";picture.style.top=`${element.y}%`;picture.style.left=`${element.x}%`;picture.style.transform="translate(-50%, -50%)";picture.dataset.originalTransform="translate(-50%, -50%)";picture.style.width=element.width;picture.style.aspectRatio=element.aspectRatio;const img=document.createElement("img");img.src=element.location==="local"?element.url:element.url;img.style.width="100%";img.style.height="100%";img.style.objectFit="contain";img.onerror=()=>{console.warn(`Failed to load image: ${img.src}`);img.style.display="none";const placeholder=document.createElement("div");placeholder.style.width="100%";placeholder.style.height="100%";placeholder.style.display="flex";placeholder.style.alignItems="center";placeholder.style.justifyContent="center";placeholder.style.background="rgba(200, 200, 200, 0.3)";placeholder.style.border="2px dashed rgba(150, 150, 150, 0.5)";placeholder.style.borderRadius="4px";placeholder.style.color="rgba(100, 100, 100, 0.7)";placeholder.style.fontSize="14px";placeholder.innerHTML="📷<br>Image<br>Failed";picture.appendChild(placeholder)};picture.appendChild(img);if(element.clickable){img.style.transition=`transform ${this.defaultScaleDuration}ms ease`;img.style.transformOrigin="center";picture.classList.add("clickable");picture.style.cursor="pointer";picture.addEventListener("click",()=>{let targetScene="";if(element.clickActions){const navigateAction=element.clickActions.find(action=>action.action==="navigate"&&action.target==="scene");if(navigateAction){targetScene=navigateAction.value}}let value="";if(this.quizConfig&&element.clickActions&&element.clickActions.some(action=>action.action==="selectAnswer")){const currentQuestion=this.quizConfig.questions[this.currentQuestionIndex];const answer=currentQuestion.answers.find(a=>a.element===element.id);if(answer){value=answer.correct?"correct":"incorrect"}}else if(targetScene){value="navigate"}let subScene="";if(this.currentScene==="quiz"&&this.quizConfig&&this.currentQuestionIndex>=0){const currentQuestion=this.quizConfig.questions[this.currentQuestionIndex];if(currentQuestion){subScene=currentQuestion.id}}if(window.emit){window.emit({scene:this.currentScene,sub_scene:subScene,action:"button_click",self:element.id,value:value,target:targetScene})}this.executeClickActions(element.clickActions,img)})}parentElement.appendChild(picture)}else if(element.type==="quiz"){this.quizConfig=element.config;this.currentQuestionIndex=0;return}else if(element.type==="exploration"){this.explorationConfig=element.config;return}};Game.prototype.executeClickActions=function(actions,targetElement){if(!actions)return;actions.forEach(action=>{if(action.action==="scale"){const duration=action.duration||this.defaultScaleDuration;targetElement.style.transition=`transform ${duration}ms ease`;targetElement.style.transform=`scale(${action.value})`;setTimeout(()=>{targetElement.style.transform=""},duration)}else if(action.action==="visibility"){const targetEl=document.getElementById(action.target);if(targetEl){if(action.value==="visible"){targetEl.classList.remove("hidden")}else if(action.value==="hidden"){targetEl.classList.add("hidden")}}}else if(action.action==="navigate"){const hasScale=actions.some(a=>a.action==="scale");const delay=hasScale?(actions.find(a=>a.action==="scale").duration||this.defaultScaleDuration)*2:0;setTimeout(()=>{if(action.target==="scene"){if(action.value==="quiz"){this.isContinuingFromInterstitial=false}this.switchScene(action.value)}},delay)}else if(action.action==="selectAnswer"){if(typeof this.selectQuizAnswer==="function"){this.selectQuizAnswer(action.value)}}else if(action.action==="continueFromInterstitial"){if(typeof this.continueFromInterstitial==="function"){this.continueFromInterstitial()}}})};Game.prototype.switchScene=function(scene,duration=this.gameConfig.game.fadeDuration){const currentSceneEl=document.querySelector(`[data-scene="${this.currentScene}"]`);const nextSceneEl=document.querySelector(`[data-scene="${scene}"]`);const targetSceneConfig=this.gameConfig.scenes.find(s=>s.name===scene);currentSceneEl.classList.add("hidden");setTimeout(()=>{currentSceneEl.style.display="none";if(targetSceneConfig&&targetSceneConfig.clear){this.clearScene(targetSceneConfig.name)}else if(scene==="quiz"&&this.quizConfig&&this.quizConfig.clear){this.clearScene("quiz");if(!this.isContinuingFromInterstitial&&typeof this.resetQuizState==="function"){this.resetQuizState()}}if(this.currentScene==="exploration"&&typeof this.cleanupExploration==="function"){this.cleanupExploration()}nextSceneEl.style.display="block";nextSceneEl.classList.remove("hidden");this.currentScene=scene;if(window.emit){window.emit({scene:scene,sub_scene:"",action:"scene_load",self:"",value:"",target:""})}if(targetSceneConfig.pageBackground){this.setupBackground("background",targetSceneConfig.pageBackground)}if(targetSceneConfig.containerBackground){this.setupBackground("game-container",targetSceneConfig.containerBackground)}if(typeof this.cleanupExploration==="function"){this.cleanupExploration()}if(scene==="exploration"&&this.explorationConfig&&typeof this.initExploration==="function"){this.initExploration(this.explorationConfig)}if(scene==="gameplay"){this.resetGameplay()}},duration)};Game.prototype.clearScene=function(sceneName){const sceneElement=document.getElementById(sceneName+"-scene");if(sceneElement){this.clearSceneElements(this.gameConfig.scenes.find(s=>s.name===sceneName).elements)}};Game.prototype.clearSceneElements=function(elements){elements.forEach(element=>{if(element.type==="container"&&element.elements){this.clearSceneElements(element.elements)}if(element.type==="picture"){const domElement=document.getElementById(element.id);if(domElement){if(element.hidden){domElement.classList.add("hidden")}else{domElement.classList.remove("hidden")}if(element.clickable){domElement.classList.add("clickable");domElement.style.pointerEvents=""}domElement.style.opacity="";domElement.style.border="";domElement.style.transform=domElement.dataset.originalTransform||"";domElement.style.transformOrigin="";domElement.style.transition="";const icons=domElement.querySelectorAll(".affirmation-icon");icons.forEach(icon=>icon.remove());const overlays=domElement.querySelectorAll(".affirmation-overlay");overlays.forEach(overlay=>overlay.remove())}}if(element.type==="container"){const domElement=document.getElementById(element.id);if(domElement){if(element.hidden){domElement.classList.add("hidden")}else{domElement.classList.remove("hidden")}domElement.style.opacity="";const overlays=domElement.querySelectorAll(".affirmation-overlay");overlays.forEach(overlay=>overlay.remove())}}})};Game.prototype.resetGameplay=function(){};